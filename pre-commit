#!/bin/sh
#
# A hook script to verify MATLAB code using CC4M.
# Called by "git commit" with no arguments.

## Configurable settings
# Location of the MATLAB installatio to use.
matlabRoot="/c/Program Files/MATLAB/R2025b"

# From the predefined configurations, use the "MonkeyProof Coding Standard for MATLAB".
configFile=MonkeyProofMATLABCodingStandard

# List of extensions to include.
supportedExtensions="\.m$|\.mlx$|\.slx$|\.mlapp$|\.mdl$"

## Generic settings
matlabExe="$matlabRoot/bin/matlab"
matlabInitCmd="addpath(monkeyproof.cc4m.utils.userpath())";
envdir=$USERPROFILE/Documents/MATLAB/cc4m/python/25.2

# GIT repository root folder.
gitRootFolder=$(git rev-parse --show-toplevel)

#activate Python environment
. $envdir/Scripts/activate

echo "adapt PythonPath"
export PYTHONPATH
PYTHONPATH="$envdir/Lib;$PYTHONPATH"

# Only rules with severity level equal to or higher than "severityLevelBoundary" will be included.
severityLevelBoundary=10

# Initialize variables.
gitFullFiles=
count=0

## The hook.
# Loop over files to commit, just keep files to check.
for file in $(git diff --cached --name-only --diff-filter=ACM); do
  if echo "$file" | grep -qE "$supportedExtensions"; then
    echo "$file contains MATLAB code."
    if [ 1 -eq $count ]
	then
		gitFullFiles=''$gitFullFiles,''
	fi
	gitFullFiles=$gitFullFiles''"$gitRootFolder/$file"''
	count=1
  else
	echo "$file not checked."
  fi
done

if test $count -eq 0 
then
	echo "No MATLAB files to check."
	exit 0
fi

echo "Checking MATLAB files."
echo " "
# echo "'$gitFullFiles"
# echo " "
matlabOutput=$(python -m cc4m_githooks.precommit "$envdir/Lib" "$matlabExe" "$gitRootFolder" "precommit_example('$gitFullFiles', '$configFile', $severityLevelBoundary)")
errorlevel=$?
# echo "return from python"
# echo "error: $errorlevel"
# echo "$matlabOutput"

if test $errorlevel -eq 0
then
	echo ok
	exit 0
else
	echo "Commit canceled! Critical guidelines are not followed in the M-files. This needs to be fixed first. A report opens that highlights the violations"
	echo " "
	exit 1		
fi

